<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="iOS,Objective-C,">





  <link rel="alternate" href="/atom.xml" title="leejunhui's blog" type="application/atom+xml">






<meta name="description" content="iOS 查漏补缺 - PerformSelector performSelector 系列的函数我们都不陌生，但是对于它不同的变种以及底层原理在很多时候还是容易分不清楚，所以笔者希望通过 runtime 源码以及 GUNStep 源码来一个个抽丝剥茧，把不同变种的 performSelector 理顺，并搞清楚每个方法的底层实现，如有错误，欢迎指正。 本文的代码已放在 Github ，欢迎自取">
<meta name="keywords" content="iOS,Objective-C">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS 查漏补缺 - performSelector">
<meta property="og:url" content="http://leejunhui.com/2020/03/12/iOS-查漏补缺-performSelector/index.html">
<meta property="og:site_name" content="leejunhui&#39;s blog">
<meta property="og:description" content="iOS 查漏补缺 - PerformSelector performSelector 系列的函数我们都不陌生，但是对于它不同的变种以及底层原理在很多时候还是容易分不清楚，所以笔者希望通过 runtime 源码以及 GUNStep 源码来一个个抽丝剥茧，把不同变种的 performSelector 理顺，并搞清楚每个方法的底层实现，如有错误，欢迎指正。 本文的代码已放在 Github ，欢迎自取">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://raw.githubusercontent.com/LeeJunhui/blog_images/master/20200312163817.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/LeeJunhui/blog_images/master/20200312163803.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/LeeJunhui/blog_images/master/20200312163806.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/LeeJunhui/blog_images/master/20200312163811.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/LeeJunhui/blog_images/master/15839893768175.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/LeeJunhui/blog_images/master/15839895561944.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/LeeJunhui/blog_images/master/15839897039699.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/LeeJunhui/blog_images/master/15839898047089.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/LeeJunhui/blog_images/master/performSelector.png">
<meta property="og:updated_time" content="2020-03-13T04:33:18.370Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS 查漏补缺 - performSelector">
<meta name="twitter:description" content="iOS 查漏补缺 - PerformSelector performSelector 系列的函数我们都不陌生，但是对于它不同的变种以及底层原理在很多时候还是容易分不清楚，所以笔者希望通过 runtime 源码以及 GUNStep 源码来一个个抽丝剥茧，把不同变种的 performSelector 理顺，并搞清楚每个方法的底层实现，如有错误，欢迎指正。 本文的代码已放在 Github ，欢迎自取">
<meta name="twitter:image" content="https://raw.githubusercontent.com/LeeJunhui/blog_images/master/20200312163817.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://leejunhui.com/2020/03/12/iOS-查漏补缺-performSelector/">





  <title>iOS 查漏补缺 - performSelector | leejunhui's blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">leejunhui's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://leejunhui.com/2020/03/12/iOS-查漏补缺-performSelector/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="leejunhui">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="leejunhui's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">iOS 查漏补缺 - performSelector</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-12T17:28:13+08:00">
                2020-03-12
              </time>
            

            

            
          </span>
          
          <span class="post-updated">
            &nbsp; | &nbsp; 更新于
            <time itemprop="dateUpdated" datetime="2020-03-13T12:33:18+08:00" content="2020-03-13">
              2020-03-13
            </time>
          </span>
          

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS-查漏补缺/" itemprop="url" rel="index">
                    <span itemprop="name">iOS 查漏补缺</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="iOS-查漏补缺-PerformSelector"><a href="#iOS-查漏补缺-PerformSelector" class="headerlink" title="iOS 查漏补缺 - PerformSelector"></a>iOS 查漏补缺 - PerformSelector</h1><blockquote>
<p><code>performSelector</code> 系列的函数我们都不陌生，但是对于它不同的变种以及底层原理在很多时候还是容易分不清楚，所以笔者希望通过 <code>runtime</code> 源码以及 <code>GUNStep</code> 源码来一个个抽丝剥茧，把不同变种的 <code>performSelector</code> 理顺，并搞清楚每个方法的底层实现，如有错误，欢迎指正。</p>
<p>本文的代码已放在 <a href="https://github.com/LeeJunhui/PerformSelectorIndepth" target="_blank" rel="noopener">Github</a> ，欢迎自取</p>
</blockquote>
<a id="more"></a>
<h1 id="一、NSObject-下的-PerformSelector"><a href="#一、NSObject-下的-PerformSelector" class="headerlink" title="一、NSObject 下的 PerformSelector"></a>一、NSObject 下的 <code>PerformSelector</code></h1><h2 id="1-1-探索"><a href="#1-1-探索" class="headerlink" title="1.1 探索"></a>1.1 探索</h2><ul>
<li><code>performSelector:(SEL)aSelector</code> </li>
</ul>
<p><code>performSelector</code> 方法是最简单的一个 <code>api</code>，使用方法如下</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)jh_performSelector</span><br><span class="line">&#123;</span><br><span class="line">     [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(task)];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)task</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"><span class="number">2020</span><span class="number">-03</span><span class="number">-12</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">26.321254</span>+<span class="number">0800</span> PerformSelectorIndepth[<span class="number">61807</span>:<span class="number">828757</span>] -[ViewController task]</span><br></pre></td></tr></table></figure>

<p><code>performSelector:</code> 方法只需要传入一个 <code>SEL</code>，在 <code>runtime</code> 底层实现为：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)performSelector:(SEL)sel &#123;</span><br><span class="line">    <span class="keyword">if</span> (!sel) [<span class="keyword">self</span> doesNotRecognizeSelector:sel];</span><br><span class="line">    <span class="keyword">return</span> ((<span class="keyword">id</span>(*)(<span class="keyword">id</span>, SEL))objc_msgSend)(<span class="keyword">self</span>, sel);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<ul>
<li><code>performSelector:(SEL)aSelector withObject:(id)object</code> </li>
</ul>
<p><code>performSelector:withObject:</code> 方法相比于上一个方法多了一个参数，使用起来如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)jh_performSelectorWithObj</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(taskWithParam:) withObject:@&#123;<span class="string">@"param"</span>: <span class="string">@"leejunhui"</span>&#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)taskWithParam:(<span class="built_in">NSDictionary</span> *)param</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, param);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"><span class="number">2020</span><span class="number">-03</span><span class="number">-12</span> <span class="number">11</span>:<span class="number">12</span>:<span class="number">34.473153</span>+<span class="number">0800</span> PerformSelectorIndepth[<span class="number">61790</span>:<span class="number">827408</span>] -[ViewController taskWithParam:]</span><br><span class="line"><span class="number">2020</span><span class="number">-03</span><span class="number">-12</span> <span class="number">11</span>:<span class="number">12</span>:<span class="number">34.473381</span>+<span class="number">0800</span> PerformSelectorIndepth[<span class="number">61790</span>:<span class="number">827408</span>] &#123;</span><br><span class="line">    param = leejunhui;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>performSelector:withObject:</code> 方法底层实现如下:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)performSelector:(SEL)sel withObject:(<span class="keyword">id</span>)obj &#123;</span><br><span class="line">    <span class="keyword">if</span> (!sel) [<span class="keyword">self</span> doesNotRecognizeSelector:sel];</span><br><span class="line">    <span class="keyword">return</span> ((<span class="keyword">id</span>(*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))objc_msgSend)(<span class="keyword">self</span>, sel, obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<ul>
<li><code>performSelector:(SEL)aSelector withObject:(id)object1 withObject:(id)object2</code> </li>
</ul>
<p>这个方法相比上一个方法又多了一个参数:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)jh_performSelectorWithObj1AndObj2</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(taskWithParam1:param2:) withObject:@&#123;<span class="string">@"param1"</span>: <span class="string">@"lee"</span>&#125; withObject:@&#123;<span class="string">@"param2"</span>: <span class="string">@"junhui"</span>&#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)taskWithParam1:(<span class="built_in">NSDictionary</span> *)param1 param2:(<span class="built_in">NSDictionary</span> *)param2</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, param1);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, param2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"><span class="number">2020</span><span class="number">-03</span><span class="number">-12</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">52.889731</span>+<span class="number">0800</span> PerformSelectorIndepth[<span class="number">61859</span>:<span class="number">833076</span>] -[ViewController taskWithParam1:param2:]</span><br><span class="line"><span class="number">2020</span><span class="number">-03</span><span class="number">-12</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">52.889921</span>+<span class="number">0800</span> PerformSelectorIndepth[<span class="number">61859</span>:<span class="number">833076</span>] &#123;</span><br><span class="line">    param1 = lee;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">2020</span><span class="number">-03</span><span class="number">-12</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">52.890009</span>+<span class="number">0800</span> PerformSelectorIndepth[<span class="number">61859</span>:<span class="number">833076</span>] &#123;</span><br><span class="line">    param2 = junhui;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>performSelector:withObject:withObject:</code> 方法底层实现如下:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)performSelector:(SEL)sel withObject:(<span class="keyword">id</span>)obj1 withObject:(<span class="keyword">id</span>)obj2 &#123;</span><br><span class="line">    <span class="keyword">if</span> (!sel) [<span class="keyword">self</span> doesNotRecognizeSelector:sel];</span><br><span class="line">    <span class="keyword">return</span> ((<span class="keyword">id</span>(*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>, <span class="keyword">id</span>))objc_msgSend)(<span class="keyword">self</span>, sel, obj1, obj2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="1-2-小结"><a href="#1-2-小结" class="headerlink" title="1.2 小结"></a>1.2 小结</h2><table>
<thead>
<tr>
<th>方法</th>
<th>底层实现</th>
</tr>
</thead>
<tbody><tr>
<td>performSelector:</td>
<td>((id(*)(id, SEL))objc_msgSend)(self, sel)</td>
</tr>
<tr>
<td>performSelector:withObject:</td>
<td>((id(*)(id, SEL, id))objc_msgSend)(self, sel, obj)</td>
</tr>
<tr>
<td>performSelector:withObject:withObject:</td>
<td>((id(*)(id, SEL, id, id))objc_msgSend)(self, sel, obj1, obj2)</td>
</tr>
</tbody></table>
<p>这三个方法应该是使用频率很高的 <code>performSelector</code> 系列方法了，我们只需要记住这三个方法在底层都是执行的<strong>消息发送</strong>即可。</p>
<h1 id="二、Runloop-相关的-PerformSelector"><a href="#二、Runloop-相关的-PerformSelector" class="headerlink" title="二、Runloop 相关的 PerformSelector"></a>二、Runloop 相关的 <code>PerformSelector</code></h1><p><img src="https://raw.githubusercontent.com/LeeJunhui/blog_images/master/20200312163817.jpg" alt></p>
<p>如上图所示，在 <code>NSRunLoop</code> 头文件中，定义了两个的分类，分别是 </p>
<ul>
<li><code>NSDelayedPerforming</code> 对应于 <code>NSObject</code> </li>
<li><code>NSOrderedPerform</code> 对应于 <code>NSRunLoop</code></li>
</ul>
<h2 id="2-1-NSObject-分类-NSDelayedPerforming"><a href="#2-1-NSObject-分类-NSDelayedPerforming" class="headerlink" title="2.1 NSObject 分类 NSDelayedPerforming"></a>2.1 NSObject 分类 NSDelayedPerforming</h2><h3 id="2-1-1-探索"><a href="#2-1-1-探索" class="headerlink" title="2.1.1 探索"></a>2.1.1 探索</h3><ul>
<li><code>performSelector:WithObject:afterDelay:</code></li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)jh_performSelectorwithObjectafterDelay</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(taskWithParam:) withObject:@&#123;<span class="string">@"param"</span>: <span class="string">@"leejunhui"</span>&#125; afterDelay:<span class="number">1.</span>f];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)taskWithParam:(<span class="built_in">NSDictionary</span> *)param</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, param);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"><span class="number">2020</span><span class="number">-03</span><span class="number">-12</span> <span class="number">11</span>:<span class="number">25</span>:<span class="number">01.475634</span>+<span class="number">0800</span> PerformSelectorIndepth[<span class="number">61898</span>:<span class="number">838345</span>] -[ViewController taskWithParam:]</span><br><span class="line"><span class="number">2020</span><span class="number">-03</span><span class="number">-12</span> <span class="number">11</span>:<span class="number">25</span>:<span class="number">01.475837</span>+<span class="number">0800</span> PerformSelectorIndepth[<span class="number">61898</span>:<span class="number">838345</span>] &#123;</span><br><span class="line">    param = leejunhui;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p> This method sets up a timer to perform the aSelector message on the current thread’s run loop. The timer is configured to run in the default mode (NSDefaultRunLoopMode). When the timer fires, the thread attempts to dequeue the message from the run loop and perform the selector. It succeeds if the run loop is running and in the default mode; otherwise, the timer waits until the run loop is in the default mode.</p>
<p>这个方法会在当前线程所对应的 runloop 中设置一个定时器来执行传入的 SEL。定时器需要在 NSDefaultRunLoopMode 模式下才会被触发。当定时器启动后，线程会尝试从 runloop 中取出 SEL 然后执行。<br>     如果 runloop 已经启动并且处于 NSDefaultRunLoopMode 的话，SEL 执行成功。否则，直到 runloop 处于 NSDefaultRunLoopMode 前，timer 都会一直等待</p>
</blockquote>
<p>通过断点调试如下图所示，runloop 底层最终是通过 <code>__CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__ ()</code>来触发任务的执行。</p>
<p><img src="https://raw.githubusercontent.com/LeeJunhui/blog_images/master/20200312163803.jpg" alt></p>
<p>因为 <code>NSRunLoop</code> 并没有开源，所以我们只能通过 <code>GNUStep</code> 来窥探底层实现细节，如下所示：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>) performSelector: (SEL)aSelector</span><br><span class="line">	      withObject: (<span class="keyword">id</span>)argument</span><br><span class="line">	      afterDelay: (<span class="built_in">NSTimeInterval</span>)seconds</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">NSRunLoop</span>		*loop = [<span class="built_in">NSRunLoop</span> currentRunLoop];</span><br><span class="line">  GSTimedPerformer	*item;</span><br><span class="line"></span><br><span class="line">  item = [[GSTimedPerformer alloc] initWithSelector: aSelector</span><br><span class="line">					     target: <span class="keyword">self</span></span><br><span class="line">					   argument: argument</span><br><span class="line">					      delay: seconds];</span><br><span class="line">  [[loop _timedPerformers] addObject: item];</span><br><span class="line">  RELEASE(item);</span><br><span class="line">  [loop addTimer: item-&gt;timer forMode: <span class="built_in">NSDefaultRunLoopMode</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The GSTimedPerformer class is used to hold information about</span></span><br><span class="line"><span class="comment"> * messages which are due to be sent to objects at a particular time.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">GSTimedPerformer</span>: <span class="title">NSObject</span></span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">@public</span></span><br><span class="line">  SEL		selector;</span><br><span class="line">  <span class="keyword">id</span>		target;</span><br><span class="line">  <span class="keyword">id</span>		argument;</span><br><span class="line">  <span class="built_in">NSTimer</span>	*timer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>) fire;</span><br><span class="line">- (<span class="keyword">id</span>) initWithSelector: (SEL)aSelector</span><br><span class="line">		 target: (<span class="keyword">id</span>)target</span><br><span class="line">	       argument: (<span class="keyword">id</span>)argument</span><br><span class="line">		  delay: (<span class="built_in">NSTimeInterval</span>)delay;</span><br><span class="line">- (<span class="keyword">void</span>) invalidate;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>我们可以看到，在 <code>performSelector:WithObject:afterDelay:</code> 底层</p>
<ul>
<li>获取当前线程的 <code>NSRunLoop</code> 对象。</li>
<li>通过传入的 <code>SEL</code> 、<code>argument</code> 和 <code>delay</code> 初始化一个 <code>GSTimedPerformer</code> 实例对象，<code>GSTimedPerformer</code> 类型里面封装了 <code>NSTimer</code> 对象。</li>
<li>然后把 <code>GSTimedPerformer</code> 实例加入到 <code>RunLoop</code> 对象的 <code>_timedPerformers</code> 成员变量中</li>
<li>释放掉 <code>GSTimedPerformer</code> 对象</li>
<li>以 <code>default mode</code> 将 <code>timer</code> 对象加入到 <code>runloop</code> 中</li>
</ul>
<hr>
<ul>
<li><code>performSelector:WithObject:afterDelay:inModes</code></li>
</ul>
<p><code>performSelector:WithObject:afterDelay:inModes</code> 方法相比上个方法多了一个 <code>modes</code> 参数，根据官方文档的定义，只有当 <code>runloop</code> 处于 <code>modes</code> 中的任意一个 <code>mode</code> 时，才会执行任务，如果 <code>modes</code> 为空，那么将不会执行任务。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)jh_performSelectorwithObjectafterDelayInModes</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(taskWithParam:) withObject:@&#123;<span class="string">@"param"</span>: <span class="string">@"leejunhui"</span>&#125; afterDelay:<span class="number">1.</span>f inModes:@[<span class="built_in">NSRunLoopCommonModes</span>]];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)taskWithParam:(<span class="built_in">NSDictionary</span> *)param</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, param);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印如下</span></span><br><span class="line"><span class="number">2020</span><span class="number">-03</span><span class="number">-12</span> <span class="number">11</span>:<span class="number">38</span>:<span class="number">58.479152</span>+<span class="number">0800</span> PerformSelectorIndepth[<span class="number">62006</span>:<span class="number">851520</span>] -[ViewController taskWithParam:]</span><br><span class="line"><span class="number">2020</span><span class="number">-03</span><span class="number">-12</span> <span class="number">11</span>:<span class="number">38</span>:<span class="number">58.479350</span>+<span class="number">0800</span> PerformSelectorIndepth[<span class="number">62006</span>:<span class="number">851520</span>] &#123;</span><br><span class="line">    param = leejunhui;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里我们如果把 <code>modes</code> 参数改为 <code>UITrackingRunLoopMode</code>，那么就只有在 <code>scrollView</code> 发生滚动的时候才会触发 timer</p>
</blockquote>
<p>我们再看一下 <code>GNUStep</code> 对应的实现：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>) performSelector: (SEL)aSelector</span><br><span class="line">	      withObject: (<span class="keyword">id</span>)argument</span><br><span class="line">	      afterDelay: (<span class="built_in">NSTimeInterval</span>)seconds</span><br><span class="line">		 inModes: (<span class="built_in">NSArray</span>*)modes</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">unsigned</span>	count = [modes count];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (count &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">NSRunLoop</span>		*loop = [<span class="built_in">NSRunLoop</span> currentRunLoop];</span><br><span class="line">      <span class="built_in">NSString</span>		*marray[count];</span><br><span class="line">      GSTimedPerformer	*item;</span><br><span class="line">      <span class="keyword">unsigned</span>		i;</span><br><span class="line"></span><br><span class="line">      item = [[GSTimedPerformer alloc] initWithSelector: aSelector</span><br><span class="line">						 target: <span class="keyword">self</span></span><br><span class="line">					       argument: argument</span><br><span class="line">						  delay: seconds];</span><br><span class="line">      [[loop _timedPerformers] addObject: item];</span><br><span class="line">      RELEASE(item);</span><br><span class="line">      <span class="keyword">if</span> ([modes isProxy])</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">	    &#123;</span><br><span class="line">	      marray[i] = [modes objectAtIndex: i];</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">          [modes getObjects: marray];</span><br><span class="line">	&#125;</span><br><span class="line">      <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">	&#123;</span><br><span class="line">	  [loop addTimer: item-&gt;timer forMode: marray[i]];</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>可以看到，相比于上一个方法的底层实现不同的是，这里会循环添加不同 <code>mode</code> 的 <code>timer</code> 对象到 <code>runloop</code> 中。</p>
<hr>
<ul>
<li><code>cancelPreviousPerformRequestsWithTarget:</code> 和 <code>cancelPreviousPerformRequestsWithTarget:selector:object:</code></li>
</ul>
<p><code>cancelPreviousPerformRequestsWithTarget:</code> 方法和 <code>cancelPreviousPerformRequestsWithTarget:selector:object:</code> 方法是两个类方法，它们的作用是取消执行之前通过 <code>performSelector:WithObject:afterDelay:</code> 方法注册的任务。使用起来如下所示:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)jh_performSelectorwithObjectafterDelayInModes</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 只有当 scrollView 发生滚动时，才会触发timer</span></span><br><span class="line"><span class="comment">//    [self performSelector:@selector(taskWithParam:) withObject:@&#123;@"param": @"leejunhui"&#125; afterDelay:1.f inModes:@[UITrackingRunLoopMode]];</span></span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(taskWithParam:) withObject:@&#123;<span class="string">@"param"</span>: <span class="string">@"leejunhui"</span>&#125; afterDelay:<span class="number">5.</span>f inModes:@[<span class="built_in">NSRunLoopCommonModes</span>]];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">IBAction</span>)cancelTask &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</span><br><span class="line">    [ViewController cancelPreviousPerformRequestsWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(taskWithParam:) object:@&#123;<span class="string">@"param"</span>: <span class="string">@"leejunhui"</span>&#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// [ViewController cancelPreviousPerformRequestsWithTarget:self];</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"><span class="number">2020</span><span class="number">-03</span><span class="number">-12</span> <span class="number">11</span>:<span class="number">52</span>:<span class="number">33.549213</span>+<span class="number">0800</span> PerformSelectorIndepth[<span class="number">62172</span>:<span class="number">865289</span>] -[ViewController cancelTask]</span><br></pre></td></tr></table></figure>

<p>这里有一个区别，就是 <code>cancelPreviousPerformRequestsWithTarget:</code> 类方法会取消掉 <code>target</code> 上所有的通过 <code>performSelector:WithObject:afterDelay:</code> 实例方法注册的定时任务，而 <code>cancelPreviousPerformRequestsWithTarget:selector:object:</code> 只会通过传入的 <code>SEL</code> 取消匹配到的定时任务</p>
<p>在 <code>GNUStep</code> 中 <code>cancelPreviousPerformRequestsWithTarget:</code> 方法底层实现如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Cancels any perform operations set up for the specified target</span></span><br><span class="line"><span class="comment"> * in the current run loop.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="keyword">void</span>) cancelPreviousPerformRequestsWithTarget: (<span class="keyword">id</span>)target</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span>	*perf = [[<span class="built_in">NSRunLoop</span> currentRunLoop] _timedPerformers];</span><br><span class="line">    <span class="keyword">unsigned</span>		count = [perf count];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        GSTimedPerformer	*array[count];</span><br><span class="line">        </span><br><span class="line">        IF_NO_GC(RETAIN(target));</span><br><span class="line">        [perf getObjects: array];</span><br><span class="line">        <span class="keyword">while</span> (count-- &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            GSTimedPerformer	*p = array[count];</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (p-&gt;target == target)</span><br><span class="line">            &#123;</span><br><span class="line">                [p invalidate];</span><br><span class="line">                [perf removeObjectAtIndex: count];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        RELEASE(target);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GSTimedPerformer 实例方法</span></span><br><span class="line">- (<span class="keyword">void</span>) invalidate</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (timer != <span class="literal">nil</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        [timer invalidate];</span><br><span class="line">        DESTROY(timer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的逻辑其实很清晰：</p>
<ul>
<li>取出当前 runloop 对象的成员变量 <code>_timedPerformers</code></li>
<li>判断定时任务数组是否为空，不为空才会继续往下走</li>
<li>初始化一个局部的空的任务数组，然后通过 <code>getObjects</code> 从成员变量中取出任务</li>
<li>通过 while 循环遍历所有的任务，如果匹配到了对应的 <code>target</code>，则调用任务的 invalidate 方法，在这个方法内部会把定时器停掉然后销毁。接着还需要把成员变量 <code>_timedPerformers</code> 中对应的任务移除掉</li>
</ul>
<p>另一个取消任务的方法底层实现如下:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Cancels any perform operations set up for the specified target</span></span><br><span class="line"><span class="comment"> * in the current loop, but only if the value of aSelector and argument</span></span><br><span class="line"><span class="comment"> * with which the performs were set up match those supplied.&lt;br /&gt;</span></span><br><span class="line"><span class="comment"> * Matching of the argument may be either by pointer equality or by</span></span><br><span class="line"><span class="comment"> * use of the [NSObject-isEqual:] method.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="keyword">void</span>) cancelPreviousPerformRequestsWithTarget: (<span class="keyword">id</span>)target</span><br><span class="line">                                        selector: (SEL)aSelector</span><br><span class="line">                                          object: (<span class="keyword">id</span>)arg</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span>	*perf = [[<span class="built_in">NSRunLoop</span> currentRunLoop] _timedPerformers];</span><br><span class="line">    <span class="keyword">unsigned</span>		count = [perf count];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        GSTimedPerformer	*array[count];</span><br><span class="line">        </span><br><span class="line">        IF_NO_GC(RETAIN(target));</span><br><span class="line">        IF_NO_GC(RETAIN(arg));</span><br><span class="line">        [perf getObjects: array];</span><br><span class="line">        <span class="keyword">while</span> (count-- &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            GSTimedPerformer	*p = array[count];</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (p-&gt;target == target &amp;&amp; sel_isEqual(p-&gt;selector, aSelector)</span><br><span class="line">                &amp;&amp; (p-&gt;argument == arg || [p-&gt;argument isEqual: arg]))</span><br><span class="line">            &#123;</span><br><span class="line">                [p invalidate];</span><br><span class="line">                [perf removeObjectAtIndex: count];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        RELEASE(arg);</span><br><span class="line">        RELEASE(target);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的实现不一样的地方就是除了判断 <code>target</code> 是否匹配外，还会判断 <code>SEL</code> 是否匹配，以及参数是否匹配。</p>
<hr>
<h3 id="2-1-2-小结"><a href="#2-1-2-小结" class="headerlink" title="2.1.2 小结"></a>2.1.2 小结</h3><ul>
<li><code>performSelector:WithObject:afterDelay:</code><ul>
<li>在该方法所在线程的 runloop 处于 default mode 时，根据给定的时间触发给定的任务。底层原理是把一个 timer 对象以 <strong>default mode</strong> 加入到 runloop 对象中，等待唤醒。</li>
</ul>
</li>
<li><code>performSelector:WithObject:afterDelay:inModes:</code><ul>
<li>在该方法所在线程的 runloop 处于给定的任一 mode 时，根据给定的时间触发给定的任务。底层原理是循环把一个 timer 对象以给定的 mode 加入到 runloop 对象中，等待唤醒。</li>
</ul>
</li>
<li><code>cancelPreviousPerformRequestsWithTarget:</code><ul>
<li>取消 <code>target</code> 对象通过 <code>performSelector:WithObject:afterDelay:</code>  方法或 <code>performSelector:WithObject:afterDelay:inModes:</code> 方法注册的<strong>所有定时任务</strong></li>
</ul>
</li>
<li><code>cancelPreviousPerformRequestsWithTarget:selector:object:</code><ul>
<li>取消 <code>target</code> 对象通过 <code>performSelector:WithObject:afterDelay:</code>  方法或 <code>performSelector:WithObject:afterDelay:inModes:</code> 方法注册的<strong>指定的定时任务</strong></li>
</ul>
</li>
</ul>
<p>这四个方法是作为 <code>NSObject</code> 的 <code>NSDelayedPerforming</code> 分类存在于 <code>NSRunLoop</code> 源代码中，所以我们在使用的时候要注意一个细节，那就是执行这些方法的线程是否是主线程，如果是主线程，那么执行起来是没有问题的，但是，<strong>如果是在子线程中执行这些方法，则需要开启子线程对应的 runloop 才能保证执行成功</strong>。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)jh_performSelectorwithObjectafterDelay</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">        [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(taskWithParam:) withObject:@&#123;<span class="string">@"param"</span>: <span class="string">@"leejunhui"</span>&#125; afterDelay:<span class="number">1.</span>f];</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line"><span class="comment">//    [self performSelector:@selector(taskWithParam:) withObject:@&#123;@"param": @"leejunhui"&#125; afterDelay:1.f];</span></span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">- (<span class="keyword">void</span>)taskWithParam:(<span class="built_in">NSDictionary</span> *)param</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, param);</span><br><span class="line">&#125;    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 没有输出</span></span><br></pre></td></tr></table></figure>

<p>如上所示的代码，通过 <code>GCD</code> 的异步执行函数在全局并发队列上执行任务，并没有任何打印输出，我们加入 runloop 的启动代码后结果将完全不一样：</p>
<p><img src="https://raw.githubusercontent.com/LeeJunhui/blog_images/master/20200312163806.jpg" alt></p>
<p>对于 <code>performSelector:WithObject:afterDelay:inModes</code> 方法，如果遇到这样的情况，也是一样的解决方案。</p>
<h2 id="2-2-NSRunLoop-的分类-NSOrderedPerform"><a href="#2-2-NSRunLoop-的分类-NSOrderedPerform" class="headerlink" title="2.2 NSRunLoop 的分类 NSOrderedPerform"></a>2.2 NSRunLoop 的分类 NSOrderedPerform</h2><h3 id="2-2-1-小结"><a href="#2-2-1-小结" class="headerlink" title="2.2.1 小结"></a>2.2.1 小结</h3><ul>
<li>performSelector:target:argument:order:modes:</li>
</ul>
<p><code>performSelector:target:argument:order:modes:</code> 方法的调用者是 <code>NSRunLoop</code> 实例，然后需要传入要执行的 <code>SEL</code>，以及 <code>SEL</code> 对应的 <code>target</code>，和 <code>SEL</code> 要接收的参数 <code>argument</code>，最后是此次任务的优先级 <code>order</code>，以及一个 <strong>运行模式集合</strong> <code>modes</code>，目的是当 <code>runloop</code> 的 <code>currentMode</code> 处于这个运行模式集合中的其中任意一个 mode 时，就会按照优先级 <code>order</code> 来触发 <code>SEL</code> 的执行。具体使用如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)jh_performSelectorTargetArgumentOrderModes</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSRunLoop</span> *runloop = [<span class="built_in">NSRunLoop</span> currentRunLoop];</span><br><span class="line">    [runloop performSelector:<span class="keyword">@selector</span>(runloopTask5) target:<span class="keyword">self</span> argument:<span class="literal">nil</span> order:<span class="number">5</span> modes:@[<span class="built_in">NSRunLoopCommonModes</span>]];</span><br><span class="line">    [runloop performSelector:<span class="keyword">@selector</span>(runloopTask1) target:<span class="keyword">self</span> argument:<span class="literal">nil</span> order:<span class="number">1</span> modes:@[<span class="built_in">NSRunLoopCommonModes</span>]];</span><br><span class="line">    [runloop performSelector:<span class="keyword">@selector</span>(runloopTask3) target:<span class="keyword">self</span> argument:<span class="literal">nil</span> order:<span class="number">3</span> modes:@[<span class="built_in">NSRunLoopCommonModes</span>]];</span><br><span class="line">    [runloop performSelector:<span class="keyword">@selector</span>(runloopTask2) target:<span class="keyword">self</span> argument:<span class="literal">nil</span> order:<span class="number">2</span> modes:@[<span class="built_in">NSRunLoopCommonModes</span>]];</span><br><span class="line">    [runloop performSelector:<span class="keyword">@selector</span>(runloopTask4) target:<span class="keyword">self</span> argument:<span class="literal">nil</span> order:<span class="number">4</span> modes:@[<span class="built_in">NSRunLoopCommonModes</span>]];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)runloopTask1</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"runloop 任务1"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)runloopTask2</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"runloop 任务2"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)runloopTask3</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"runloop 任务3"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)runloopTask4</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"runloop 任务4"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)runloopTask5</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"runloop 任务5"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"><span class="number">2020</span><span class="number">-03</span><span class="number">-12</span> <span class="number">14</span>:<span class="number">23</span>:<span class="number">27.088636</span>+<span class="number">0800</span> PerformSelectorIndepth[<span class="number">62976</span>:<span class="number">972980</span>] runloop 任务<span class="number">1</span></span><br><span class="line"><span class="number">2020</span><span class="number">-03</span><span class="number">-12</span> <span class="number">14</span>:<span class="number">23</span>:<span class="number">27.088760</span>+<span class="number">0800</span> PerformSelectorIndepth[<span class="number">62976</span>:<span class="number">972980</span>] runloop 任务<span class="number">2</span></span><br><span class="line"><span class="number">2020</span><span class="number">-03</span><span class="number">-12</span> <span class="number">14</span>:<span class="number">23</span>:<span class="number">27.088868</span>+<span class="number">0800</span> PerformSelectorIndepth[<span class="number">62976</span>:<span class="number">972980</span>] runloop 任务<span class="number">3</span></span><br><span class="line"><span class="number">2020</span><span class="number">-03</span><span class="number">-12</span> <span class="number">14</span>:<span class="number">23</span>:<span class="number">27.088964</span>+<span class="number">0800</span> PerformSelectorIndepth[<span class="number">62976</span>:<span class="number">972980</span>] runloop 任务<span class="number">4</span></span><br><span class="line"><span class="number">2020</span><span class="number">-03</span><span class="number">-12</span> <span class="number">14</span>:<span class="number">23</span>:<span class="number">27.089048</span>+<span class="number">0800</span> PerformSelectorIndepth[<span class="number">62976</span>:<span class="number">972980</span>] runloop 任务<span class="number">5</span></span><br></pre></td></tr></table></figure>

<p>可以看到输出结果就是按照我们传入的 <code>order</code> 参数作为任务执行的顺序。</p>
<p><code>GUNStep</code> 中这个底层的底层实现如下:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>) performSelector: (SEL)aSelector</span><br><span class="line">                  target: (<span class="keyword">id</span>)target</span><br><span class="line">                argument: (<span class="keyword">id</span>)argument</span><br><span class="line">                   order: (<span class="built_in">NSUInteger</span>)order</span><br><span class="line">                   modes: (<span class="built_in">NSArray</span>*)modes</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">unsigned</span>		count = [modes count];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">NSString</span>			*array[count];</span><br><span class="line">        GSRunLoopPerformer	*item;</span><br><span class="line">        </span><br><span class="line">        item = [[GSRunLoopPerformer alloc] initWithSelector: aSelector</span><br><span class="line">                                                     target: target</span><br><span class="line">                                                   argument: argument</span><br><span class="line">                                                      order: order];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ([modes isProxy])</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">unsigned</span>	i;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                array[i] = [modes objectAtIndex: i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            [modes getObjects: array];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (count-- &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">NSString</span>	*mode = array[count];</span><br><span class="line">            <span class="keyword">unsigned</span>	end;</span><br><span class="line">            <span class="keyword">unsigned</span>	i;</span><br><span class="line">            GSRunLoopCtxt	*context;</span><br><span class="line">            GSIArray	performers;</span><br><span class="line">            </span><br><span class="line">            context = <span class="built_in">NSMapGet</span>(_contextMap, mode);</span><br><span class="line">            <span class="keyword">if</span> (context == <span class="literal">nil</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                context = [[GSRunLoopCtxt alloc] initWithMode: mode</span><br><span class="line">                                                        extra: _extra];</span><br><span class="line">                <span class="built_in">NSMapInsert</span>(_contextMap, context-&gt;mode, context);</span><br><span class="line">                RELEASE(context);</span><br><span class="line">            &#125;</span><br><span class="line">            performers = context-&gt;performers;</span><br><span class="line">            </span><br><span class="line">            end = GSIArrayCount(performers);</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; end; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                GSRunLoopPerformer	*p;</span><br><span class="line">                </span><br><span class="line">                p = GSIArrayItemAtIndex(performers, i).obj;</span><br><span class="line">                <span class="keyword">if</span> (p-&gt;order &gt; order)</span><br><span class="line">                &#123;</span><br><span class="line">                    GSIArrayInsertItem(performers, (GSIArrayItem)((<span class="keyword">id</span>)item), i);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (i == end)</span><br><span class="line">            &#123;</span><br><span class="line">                GSIArrayInsertItem(performers, (GSIArrayItem)((<span class="keyword">id</span>)item), i);</span><br><span class="line">            &#125;</span><br><span class="line">            i = GSIArrayCount(performers);</span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">1000</span> == <span class="number">0</span> &amp;&amp; i &gt; context-&gt;maxPerformers)</span><br><span class="line">            &#123;</span><br><span class="line">                context-&gt;maxPerformers = i;</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@"WARNING ... there are %u performers scheduled"</span></span><br><span class="line">                      <span class="string">@" in mode %@ of %@\n(Latest: [%@ %@])"</span>,</span><br><span class="line">                      i, mode, <span class="keyword">self</span>, <span class="built_in">NSStringFromClass</span>([target <span class="keyword">class</span>]),</span><br><span class="line">                      <span class="built_in">NSStringFromSelector</span>(aSelector));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        RELEASE(item);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">GSRunLoopPerformer</span>: <span class="title">NSObject</span></span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">@public</span></span><br><span class="line">    SEL		selector;</span><br><span class="line">    <span class="keyword">id</span>		target;</span><br><span class="line">    <span class="keyword">id</span>		argument;</span><br><span class="line">    <span class="keyword">unsigned</span>	order;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们已经知道了 <code>performSelector:WithObject:afterDelay:</code> 方法底层实现使用一个包裹 timer 对象的数据结构的方式，而这里是使用了一个包裹了 <code>selector</code>、<code>target</code>、<code>argument</code> 以及优先级 <code>order</code> 的数据结构的方式来实现。同时在 context 上下文的成员变量 <code>performers</code> 中存储了要执行的任务队列，所以这里实际上就是一个简单的插入排序的过程。</p>
<hr>
<ul>
<li><code>cancelPerformSelector:target:argument:</code> 和 <code>cancelPerformSelectorsWithTarget:</code></li>
</ul>
<p><code>cancelPerformSelector:target:argument:</code> 和 <code>cancelPerformSelectorsWithTarget:</code> 使用起来比较简单，一个需要传入 <code>selector</code>、<code>target</code> 和 <code>argument</code>，另一个只需要传入 <code>target</code>。它们的作用分别是根据给定的三个参数或 <code>target</code> 去 runloop 底层的 <code>performers</code> 任务队列中查找任务，找到了就从队列中移除掉。</p>
<p>而底层具体实现具体如下:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Cancels any perform operations set up for the specified target</span></span><br><span class="line"><span class="comment"> * in the receiver.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>) cancelPerformSelectorsWithTarget: (<span class="keyword">id</span>) target</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSMapEnumerator</span>	enumerator;</span><br><span class="line">    GSRunLoopCtxt		*context;</span><br><span class="line">    <span class="keyword">void</span>			*mode;</span><br><span class="line">    </span><br><span class="line">    enumerator = <span class="built_in">NSEnumerateMapTable</span>(_contextMap);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">NSNextMapEnumeratorPair</span>(&amp;enumerator, &amp;mode, (<span class="keyword">void</span>**)&amp;context))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (context != <span class="literal">nil</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            GSIArray	performers = context-&gt;performers;</span><br><span class="line">            <span class="keyword">unsigned</span>	count = GSIArrayCount(performers);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">while</span> (count--)</span><br><span class="line">            &#123;</span><br><span class="line">                GSRunLoopPerformer	*p;</span><br><span class="line">                </span><br><span class="line">                p = GSIArrayItemAtIndex(performers, count).obj;</span><br><span class="line">                <span class="keyword">if</span> (p-&gt;target == target)</span><br><span class="line">                &#123;</span><br><span class="line">                    GSIArrayRemoveItemAtIndex(performers, count);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSEndMapTableEnumeration</span>(&amp;enumerator);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Cancels any perform operations set up for the specified target</span></span><br><span class="line"><span class="comment"> * in the receiver, but only if the value of aSelector and argument</span></span><br><span class="line"><span class="comment"> * with which the performs were set up match those supplied.&lt;br /&gt;</span></span><br><span class="line"><span class="comment"> * Matching of the argument may be either by pointer equality or by</span></span><br><span class="line"><span class="comment"> * use of the [NSObject-isEqual:] method.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>) cancelPerformSelector: (SEL)aSelector</span><br><span class="line">                        target: (<span class="keyword">id</span>) target</span><br><span class="line">                      argument: (<span class="keyword">id</span>) argument</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSMapEnumerator</span>	enumerator;</span><br><span class="line">    GSRunLoopCtxt		*context;</span><br><span class="line">    <span class="keyword">void</span>			*mode;</span><br><span class="line">    </span><br><span class="line">    enumerator = <span class="built_in">NSEnumerateMapTable</span>(_contextMap);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">NSNextMapEnumeratorPair</span>(&amp;enumerator, &amp;mode, (<span class="keyword">void</span>**)&amp;context))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (context != <span class="literal">nil</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            GSIArray	performers = context-&gt;performers;</span><br><span class="line">            <span class="keyword">unsigned</span>	count = GSIArrayCount(performers);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">while</span> (count--)</span><br><span class="line">            &#123;</span><br><span class="line">                GSRunLoopPerformer	*p;</span><br><span class="line">                </span><br><span class="line">                p = GSIArrayItemAtIndex(performers, count).obj;</span><br><span class="line">                <span class="keyword">if</span> (p-&gt;target == target &amp;&amp; sel_isEqual(p-&gt;selector, aSelector)</span><br><span class="line">                    &amp;&amp; (p-&gt;argument == argument || [p-&gt;argument isEqual: argument]))</span><br><span class="line">                &#123;</span><br><span class="line">                    GSIArrayRemoveItemAtIndex(performers, count);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSEndMapTableEnumeration</span>(&amp;enumerator);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="2-2-2-小结"><a href="#2-2-2-小结" class="headerlink" title="2.2.2 小结"></a>2.2.2 小结</h3><ul>
<li><code>performSelector:target:argument:order:modes:</code> <ul>
<li>在该方法所在线程的 runloop 处于给定的任一 mode 时，且处于下一次 runloop 消息循环的开头的时候触发给定的任务。底层原理是循环把一个类似于 timer 的对象加入到 runloop 的上下文的任务队列中，等待唤醒</li>
</ul>
</li>
<li><code>cancelPerformSelector:target:argument:</code><ul>
<li>取消 target 对象通过 <code>performSelector:target:argument:order:modes:</code> 方法方法注册的<strong>指定的任务</strong></li>
</ul>
</li>
<li><code>cancelPerformSelectorsWithTarget:</code><ul>
<li>取消 target 对象通过 <code>performSelector:target:argument:order:modes:</code> 方法方法注册的<strong>所有任务</strong></li>
</ul>
</li>
</ul>
<p>这里同样的也需要注意，<strong>如果是在子线程中执行这些方法，则需要开启子线程对应的 runloop 才能保证执行成功</strong>。</p>
<h1 id="三、Thread-相关的-performSelector"><a href="#三、Thread-相关的-performSelector" class="headerlink" title="三、Thread 相关的 performSelector"></a>三、Thread 相关的 <code>performSelector</code></h1><p><img src="https://raw.githubusercontent.com/LeeJunhui/blog_images/master/20200312163811.jpg" alt></p>
<p>如上图所示，在 <code>NSThread</code> 中定义了 <code>NSObject</code> 的分类 <code>NSThreadPerformAdditions</code>，其中定义了 5 个 <code>performSelector</code> 的方法。</p>
<h2 id="3-1-探索"><a href="#3-1-探索" class="headerlink" title="3.1 探索"></a>3.1 探索</h2><ul>
<li><code>performSelector:onThread:withObject:waitUntilDone:</code> </li>
<li><code>performSelector:onThread:withObject:waitUntilDone:modes:</code></li>
</ul>
<p>根据官方文档的解释，第一个方法相当于调用了第二个方法，然后 mode 传入的是 <code>kCFRunLoopCommonModes</code>。我们这里只研究第一个方法。</p>
<p>这个方法需要相比于 <code>performSeletor:withObject:</code> 多了两个参数，分别是要哪个线程执行任务以及是否阻塞当前线程。但是使用这个方法一定要小心，如下图所示是一个常见的错误用法：</p>
<p><img src="https://raw.githubusercontent.com/LeeJunhui/blog_images/master/15839893768175.jpg" alt></p>
<p>这里报的错是 <code>target thread exited while waiting for the perform</code>，就是说已经退出的线程无法执行定时任务。<br>熟悉 <code>iOS</code> 多线程的同学都知道 <code>NSThread</code> 实例化之后的线程对象在 <code>start</code> 之后就会被系统回收，而之后调用的 <code>performSelector:onThread:withObject:waitUntilDone:</code> 方法又在一个<strong>已经回收的线程</strong>上执行任务，显然就会崩溃。这里的解决方案就是给这个子线程对应的 runloop 启动起来，让线程具有 『有事来就干活，没事干就睡觉』 的功能，具体代码如下:</p>
<p><img src="https://raw.githubusercontent.com/LeeJunhui/blog_images/master/15839895561944.jpg" alt></p>
<p>对于 <code>waitUntilDone</code> 参数，如果我们设置为 <code>YES</code>:</p>
<p><img src="https://raw.githubusercontent.com/LeeJunhui/blog_images/master/15839897039699.jpg" alt></p>
<p>如果设置为 <code>NO</code>:</p>
<p><img src="https://raw.githubusercontent.com/LeeJunhui/blog_images/master/15839898047089.jpg" alt></p>
<p>所以这里的 <code>waitUntilDone</code> 可以简单的理解为控制同步或异步执行。</p>
<p>在探索 <code>GNUStep</code> 对应实现之前，我们先熟悉一下 <code>GSRunLoopThreadInfo</code></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Used to handle events performed in one thread from another.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span>      <span class="title">GSRunLoopThreadInfo</span> : <span class="title">NSObject</span></span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">@public</span></span><br><span class="line">  <span class="built_in">NSRunLoop</span>             *loop;</span><br><span class="line">  <span class="built_in">NSLock</span>                *lock;</span><br><span class="line">  <span class="built_in">NSMutableArray</span>        *performers;</span><br><span class="line"><span class="meta">#ifdef _WIN32</span></span><br><span class="line">  HANDLE	        event;</span><br><span class="line"><span class="meta">#else</span></span><br><span class="line">  <span class="keyword">int</span>                   inputFd;</span><br><span class="line">  <span class="keyword">int</span>                   outputFd;</span><br><span class="line"><span class="meta">#endif	</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>GSRunLoopThreadInfo</code> 是每个线程特有的一个属性，存储了线程和 runloop 之间的一些信息，可以通过下面的方式获取:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">GSRunLoopThreadInfo *</span><br><span class="line">GSRunLoopInfoForThread(<span class="built_in">NSThread</span> *aThread)</span><br><span class="line">&#123;</span><br><span class="line">    GSRunLoopThreadInfo   *info;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (aThread == <span class="literal">nil</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        aThread = GSCurrentThread();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (aThread-&gt;_runLoopInfo == <span class="literal">nil</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        [gnustep_global_lock lock];</span><br><span class="line">        <span class="keyword">if</span> (aThread-&gt;_runLoopInfo == <span class="literal">nil</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            aThread-&gt;_runLoopInfo = [GSRunLoopThreadInfo new];</span><br><span class="line">        &#125;</span><br><span class="line">        [gnustep_global_lock unlock];</span><br><span class="line">    &#125;</span><br><span class="line">    info = aThread-&gt;_runLoopInfo;</span><br><span class="line">    <span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后是另一个 <code>GSPerformHolder</code>: </p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This class performs a dual function ...</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *   As a class, it is responsible for handling incoming events from</span></span><br><span class="line"><span class="comment"> *   the main runloop on a special inputFd.  This consumes any bytes</span></span><br><span class="line"><span class="comment"> *   written to wake the main runloop.&lt;br /&gt;</span></span><br><span class="line"><span class="comment"> *   During initialisation, the default runloop is set up to watch</span></span><br><span class="line"><span class="comment"> *   for data arriving on inputFd.</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *   As instances, each  instance retains perform receiver and argument</span></span><br><span class="line"><span class="comment"> *   values as long as they are needed, and handles locking to support</span></span><br><span class="line"><span class="comment"> *   methods which want to block until an action has been performed.</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *   The initialize method of this class is called before any new threads</span></span><br><span class="line"><span class="comment"> *   run.</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">GSPerformHolder</span> : <span class="title">NSObject</span></span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">id</span>			receiver;</span><br><span class="line">    <span class="keyword">id</span>			argument;</span><br><span class="line">    SEL			selector;</span><br><span class="line">    <span class="built_in">NSConditionLock</span>	*lock;		<span class="comment">// Not retained.</span></span><br><span class="line">    <span class="built_in">NSArray</span>		*modes;</span><br><span class="line">    <span class="built_in">BOOL</span>                  invalidated;</span><br><span class="line"><span class="keyword">@public</span></span><br><span class="line">    <span class="built_in">NSException</span>           *exception;</span><br><span class="line">&#125;</span><br><span class="line">+ (GSPerformHolder*) newForReceiver: (<span class="keyword">id</span>)r</span><br><span class="line">                           argument: (<span class="keyword">id</span>)a</span><br><span class="line">                           selector: (SEL)s</span><br><span class="line">                              modes: (<span class="built_in">NSArray</span>*)m</span><br><span class="line">                               lock: (<span class="built_in">NSConditionLock</span>*)l;</span><br><span class="line">- (<span class="keyword">void</span>) fire;</span><br><span class="line">- (<span class="keyword">void</span>) invalidate;</span><br><span class="line">- (<span class="built_in">BOOL</span>) isInvalidated;</span><br><span class="line">- (<span class="built_in">NSArray</span>*) modes;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p><code>GSPerformHolder</code> 封装了任务的细节(<code>receiver</code>, <code>argument</code>, <code>selector</code>)以及运行模式(<code>mode</code>)和一把条件锁( <code>NSConditionLock</code> )。</p>
<p>接着我们目光聚焦到源码 <code>performSelector:onThread:withObject:waitUntilDone:modes:</code> 具体实现上:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>) performSelector: (SEL)aSelector</span><br><span class="line">                onThread: (<span class="built_in">NSThread</span>*)aThread</span><br><span class="line">              withObject: (<span class="keyword">id</span>)anObject</span><br><span class="line">           waitUntilDone: (<span class="built_in">BOOL</span>)aFlag</span><br><span class="line">                   modes: (<span class="built_in">NSArray</span>*)anArray</span><br><span class="line">&#123;</span><br><span class="line">    GSRunLoopThreadInfo   *info;</span><br><span class="line">    <span class="built_in">NSThread</span>	        *t;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ([anArray count] == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    t = GSCurrentThread();</span><br><span class="line">    <span class="keyword">if</span> (aThread == <span class="literal">nil</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        aThread = t;</span><br><span class="line">    &#125;</span><br><span class="line">    info = GSRunLoopInfoForThread(aThread);</span><br><span class="line">    <span class="keyword">if</span> (t == aThread)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* Perform in current thread.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (aFlag == <span class="literal">YES</span> || info-&gt;loop == <span class="literal">nil</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* Wait until done or no run loop.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            [<span class="keyword">self</span> performSelector: aSelector withObject: anObject];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* Don't wait ... schedule operation in run loop.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            [info-&gt;loop performSelector: aSelector</span><br><span class="line">                                 target: <span class="keyword">self</span></span><br><span class="line">                               argument: anObject</span><br><span class="line">                                  order: <span class="number">0</span></span><br><span class="line">                                  modes: anArray];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        GSPerformHolder   *h;</span><br><span class="line">        <span class="built_in">NSConditionLock</span>	*l = <span class="literal">nil</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ([aThread isFinished] == <span class="literal">YES</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            [<span class="built_in">NSException</span> raise: <span class="built_in">NSInternalInconsistencyException</span></span><br><span class="line">                        format: <span class="string">@"perform [%@-%@] attempted on finished thread (%@)"</span>,</span><br><span class="line">             <span class="built_in">NSStringFromClass</span>([<span class="keyword">self</span> <span class="keyword">class</span>]),</span><br><span class="line">             <span class="built_in">NSStringFromSelector</span>(aSelector),</span><br><span class="line">             aThread];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (aFlag == <span class="literal">YES</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            l = [[<span class="built_in">NSConditionLock</span> alloc] init];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        h = [GSPerformHolder newForReceiver: <span class="keyword">self</span></span><br><span class="line">                                   argument: anObject</span><br><span class="line">                                   selector: aSelector</span><br><span class="line">                                      modes: anArray</span><br><span class="line">                                       lock: l];</span><br><span class="line">        [info addPerformer: h];</span><br><span class="line">        <span class="keyword">if</span> (l != <span class="literal">nil</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            [l lockWhenCondition: <span class="number">1</span>];</span><br><span class="line">            [l unlock];</span><br><span class="line">            RELEASE(l);</span><br><span class="line">            <span class="keyword">if</span> ([h isInvalidated] == <span class="literal">NO</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">/* If we have an exception passed back from the remote thread,</span></span><br><span class="line"><span class="comment">                 * re-raise it.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">nil</span> != h-&gt;exception)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">NSException</span>       *e = AUTORELEASE(RETAIN(h-&gt;exception));</span><br><span class="line">                    </span><br><span class="line">                    RELEASE(h);</span><br><span class="line">                    [e raise];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        RELEASE(h);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>声明一个<code>GSRunLoopThreadInfo</code> 对象和一条 <code>NSThread</code> 线程</li>
<li>判断运行模式数组参数是否为空</li>
<li>获取当前线程，将结果赋值于第一步声明的局部线程变量</li>
<li>判断如果传入的要执行任务的线程 aThread 如果为空，那么就把当前线程赋值于到 aThread 上</li>
<li>确保 aThread 不为空之后获取该线程对应的 <code>GSRunLoopThreadInfo</code> 对象并赋值于第一步声明的局部 info 变量</li>
<li>确保 info 有值后，判断是否是在当前线程上执行任务</li>
<li>如果是在当前线程上执行任务，接着判断是否要阻塞当前线程，或当前线程的 runloop 为空。<ul>
<li>如果是的话，则直接调用 <code>performSelector:withObject</code> 来执行任务</li>
<li>如果不是的话，则通过线程对应的 runloop 对象调用 <code>performSelector:target:argument:order:modes:</code> 来执行任务</li>
</ul>
</li>
<li>如果不是在当前线程上执行任务，声明一个 <code>GSPerformHolder</code> 局部变量，声明一把空的条件锁 <code>NSConditionLock</code><ul>
<li>判断要执行任务的线程是否已经被回收，如果已被回收，则抛出异常</li>
<li>如果未被回收<ul>
<li>判断是否要阻塞当前线程，如果传入的参数需要阻塞，则初始化条件锁</li>
<li>根据传入的参数及条件锁初始化  <code>GSPerformHolder</code> 实例</li>
<li>然后在 info 中加入 <code>GSPerformHolder</code> 实例</li>
<li>然后判断条件锁如果不为空，赋予条件锁何时加锁的条件，然后解锁条件锁，然后释放条件锁</li>
<li>判断 <code>GSPerformHolder</code> 局部变量是否已经被释放，如果没有被释放，抛出异常</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li><code>performSelectorOnMainThread:withObject:waitUntilDone:</code></li>
<li><code>performSelectorOnMainThread:withObject:waitUntilDone:modes:</code></li>
</ul>
<p>顾名思义，这两个方法其实就是在主线程上执行任务，根据传入的参数决定是否阻塞主线程，以及在哪些运行模式下执行任务。使用方法如下:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)jh_performSelectorOnMainThreadwithObjectwaitUntilDone</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">self</span> performSelectorOnMainThread:<span class="keyword">@selector</span>(threadTask:) withObject:@&#123;<span class="string">@"param"</span>: <span class="string">@"leejunhui"</span>&#125; waitUntilDone:<span class="literal">NO</span>];</span><br><span class="line"><span class="comment">//    [self performSelectorOnMainThread:@selector(threadTask:) withObject:@&#123;@"param": @"leejunhui"&#125; waitUntilDone:NO modes:@[NSRunLoopCommonModes]];</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)threadTask:(<span class="built_in">NSDictionary</span> *)param</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"><span class="number">2020</span><span class="number">-03</span><span class="number">-12</span> <span class="number">16</span>:<span class="number">14</span>:<span class="number">31.783962</span>+<span class="number">0800</span> PerformSelectorIndepth[<span class="number">63614</span>:<span class="number">1057033</span>] -[ViewController threadTask:]</span><br><span class="line"><span class="number">2020</span><span class="number">-03</span><span class="number">-12</span> <span class="number">16</span>:<span class="number">14</span>:<span class="number">31.784126</span>+<span class="number">0800</span> PerformSelectorIndepth[<span class="number">63614</span>:<span class="number">1057033</span>] &lt;<span class="built_in">NSThread</span>: <span class="number">0x600002e76dc0</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br></pre></td></tr></table></figure>

<p>因为是在主线程上执行，所以并不需要手动开启 runloop。我们来看下这两个方法在 <code>GNUStep</code> 中底层实现:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>) performSelectorOnMainThread: (SEL)aSelector</span><br><span class="line">                          withObject: (<span class="keyword">id</span>)anObject</span><br><span class="line">                       waitUntilDone: (<span class="built_in">BOOL</span>)aFlag</span><br><span class="line">                               modes: (<span class="built_in">NSArray</span>*)anArray</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* It's possible that this method could be called before the NSThread</span></span><br><span class="line"><span class="comment">     * class is initialised, so we check and make sure it's initiailised</span></span><br><span class="line"><span class="comment">     * if necessary.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (defaultThread == <span class="literal">nil</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="built_in">NSThread</span> currentThread];</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="keyword">self</span> performSelector: aSelector</span><br><span class="line">                 onThread: defaultThread</span><br><span class="line">               withObject: anObject</span><br><span class="line">            waitUntilDone: aFlag</span><br><span class="line">                    modes: anArray];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>) performSelectorOnMainThread: (SEL)aSelector</span><br><span class="line">                          withObject: (<span class="keyword">id</span>)anObject</span><br><span class="line">                       waitUntilDone: (<span class="built_in">BOOL</span>)aFlag</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">self</span> performSelectorOnMainThread: aSelector</span><br><span class="line">                           withObject: anObject</span><br><span class="line">                        waitUntilDone: aFlag</span><br><span class="line">                                modes: commonModes()];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不难看出，这里其实就是调用的 <code>performSelector:onThread:withObject:waitUntilDone:modes</code> 方法，但是有一个细节需要注意，就是有可能在 <code>NSThread</code> 类被初始化之前，就调用了 <code>performSelectorOnMainThread</code> 方法，所以需要手动调用一下 <code>[NSThread currentThread]</code>。</p>
<hr>
<ul>
<li><code>performSelectorInBackground:withObject:</code></li>
</ul>
<p>最后要探索的是 <code>performSelectorInBackground:withObject:</code> 方法，这个方法用法如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)jh_performSelectorOnBackground</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">self</span> performSelectorInBackground:<span class="keyword">@selector</span>(threadTask:) withObject:@&#123;<span class="string">@"param"</span>: <span class="string">@"leejunhui"</span>&#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)threadTask:(<span class="built_in">NSDictionary</span> *)param</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"><span class="number">2020</span><span class="number">-03</span><span class="number">-12</span> <span class="number">16</span>:<span class="number">19</span>:<span class="number">36.751675</span>+<span class="number">0800</span> PerformSelectorIndepth[<span class="number">63660</span>:<span class="number">1061569</span>] -[ViewController threadTask:]</span><br><span class="line"><span class="number">2020</span><span class="number">-03</span><span class="number">-12</span> <span class="number">16</span>:<span class="number">19</span>:<span class="number">36.751990</span>+<span class="number">0800</span> PerformSelectorIndepth[<span class="number">63660</span>:<span class="number">1061569</span>] &lt;<span class="built_in">NSThread</span>: <span class="number">0x6000027a0ac0</span>&gt;&#123;number = <span class="number">6</span>, name = (null)&#125;</span><br></pre></td></tr></table></figure>

<p>根据输出我们可知，这里显然是开了一条子线程来执行任务，我们看一下 <code>GNUStep</code> 的底层实现:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>) performSelectorInBackground: (SEL)aSelector</span><br><span class="line">                          withObject: (<span class="keyword">id</span>)anObject</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="built_in">NSThread</span> detachNewThreadSelector: aSelector</span><br><span class="line">                             toTarget: <span class="keyword">self</span></span><br><span class="line">                           withObject: anObject];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到在底层其实是调用的 <code>NSThread</code> 的类方法来执行传入的任务。关于 <code>NSThread</code> 细节我们后面会进行探索。</p>
<hr>
<h2 id="3-2-小结"><a href="#3-2-小结" class="headerlink" title="3.2 小结"></a>3.2 小结</h2><ul>
<li><code>performSelector:onThread:withObject:waitUntilDone:</code> 和 <code>performSelector:onThread:withObject:waitUntilDone:modes:</code><ul>
<li>在该方法所在线程的 runloop 处于给定的任一 mode 时，判断是否阻塞当前线程，并且处于下一次 runloop 消息循环的开头的时候触发给定的任务。</li>
</ul>
</li>
<li><code>performSelectorOnMainThread:withObject:waitUntilDone:</code> 和 <code>performSelectorOnMainThread:withObject:waitUntilDone:modes:</code><ul>
<li>当主线程的 runloop 处于给定的任一 mode 时，判断是否阻塞主线程，并且处于下一次 runloop 消息循环的开头的时候触发给定的任务。</li>
</ul>
</li>
<li><code>performSelectorInBackground:withObject:</code><ul>
<li>在子线程上执行给定的任务。底层是通过 <code>NSThread</code> 的 <code>detachNewThread</code> 实现。</li>
</ul>
</li>
</ul>
<h1 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h1><p><img src="https://raw.githubusercontent.com/LeeJunhui/blog_images/master/performSelector.png" alt></p>

      
    </div>
    
    
    

    
      <div>
        <div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center">
    <img id="wechat_subscriber_qcode" src="/uploads/wechat-qcode3.jpg" alt="leejunhui wechat" style="width: 200px; max-width: 100%;">
    <div>欢迎您扫一扫上面的微信公众号，订阅我的博客！</div>
</div>

      </div>
    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    leejunhui
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://leejunhui.com/2020/03/12/iOS-查漏补缺-performSelector/" title="iOS 查漏补缺 - performSelector">http://leejunhui.com/2020/03/12/iOS-查漏补缺-performSelector/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS/" rel="tag"># iOS</a>
          
            <a href="/tags/Objective-C/" rel="tag"># Objective-C</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/02/19/iOS-底层探索-KVO/" rel="next" title="iOS 底层探索 - KVO">
                <i class="fa fa-chevron-left"></i> iOS 底层探索 - KVO
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/03/13/iOS-查漏补缺-线程/" rel="prev" title="iOS 查漏补缺- 线程">
                iOS 查漏补缺- 线程 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/uploads/avatar.png" alt="leejunhui">
            
              <p class="site-author-name" itemprop="name">leejunhui</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#iOS-查漏补缺-PerformSelector"><span class="nav-number">1.</span> <span class="nav-text">iOS 查漏补缺 - PerformSelector</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#一、NSObject-下的-PerformSelector"><span class="nav-number">2.</span> <span class="nav-text">一、NSObject 下的 PerformSelector</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-探索"><span class="nav-number">2.1.</span> <span class="nav-text">1.1 探索</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-小结"><span class="nav-number">2.2.</span> <span class="nav-text">1.2 小结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#二、Runloop-相关的-PerformSelector"><span class="nav-number">3.</span> <span class="nav-text">二、Runloop 相关的 PerformSelector</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-NSObject-分类-NSDelayedPerforming"><span class="nav-number">3.1.</span> <span class="nav-text">2.1 NSObject 分类 NSDelayedPerforming</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-1-探索"><span class="nav-number">3.1.1.</span> <span class="nav-text">2.1.1 探索</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-2-小结"><span class="nav-number">3.1.2.</span> <span class="nav-text">2.1.2 小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-NSRunLoop-的分类-NSOrderedPerform"><span class="nav-number">3.2.</span> <span class="nav-text">2.2 NSRunLoop 的分类 NSOrderedPerform</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-1-小结"><span class="nav-number">3.2.1.</span> <span class="nav-text">2.2.1 小结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-2-小结"><span class="nav-number">3.2.2.</span> <span class="nav-text">2.2.2 小结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#三、Thread-相关的-performSelector"><span class="nav-number">4.</span> <span class="nav-text">三、Thread 相关的 performSelector</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-探索"><span class="nav-number">4.1.</span> <span class="nav-text">3.1 探索</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-小结"><span class="nav-number">4.2.</span> <span class="nav-text">3.2 小结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#四、总结"><span class="nav-number">5.</span> <span class="nav-text">四、总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2019 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">leejunhui</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        




  <script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=66522444";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
